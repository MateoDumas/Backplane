<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backplane Microservices Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 50px; background-color: #f8f9fa; }
        .card { margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        #logs { background: #212529; color: #00ff00; font-family: monospace; height: 300px; overflow-y: auto; padding: 15px; border-radius: 5px; word-break: break-all; }
        
        /* Mobile Improvements */
        @media (max-width: 768px) {
            body { padding-top: 15px; }
            #logs { height: 200px; font-size: 0.85rem; }
            h1 { font-size: 1.5rem; margin-bottom: 1.5rem !important; }
            .card { margin-bottom: 15px; }
            .container { padding-left: 10px; padding-right: 10px; }
            .btn { width: 100%; margin-bottom: 5px; } /* Full width buttons on mobile */
        }

        /* Tablet Improvements */
        @media (min-width: 769px) and (max-width: 991px) {
             #logs { height: 250px; }
        }

        .status-ok { color: green; font-weight: bold; }
        .status-err { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-5">üöÄ Backplane Microservices Dashboard</h1>
        
        <!-- System Status Monitor -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <span>üì° Monitor de Sistema (Health Checks)</span>
                        <small>Actualizaci√≥n autom√°tica cada 5s</small>
                    </div>
                    <div class="card-body">
                        <div class="row text-center g-3">
                            <div class="col-6 col-md-3" id="status-auth">
                                <h6 class="small">Auth Service</h6>
                                <span class="badge bg-secondary">Checking...</span>
                            </div>
                            <div class="col-6 col-md-3" id="status-payment">
                                <h6 class="small">Payment Service</h6>
                                <span class="badge bg-secondary">Checking...</span>
                            </div>
                            <div class="col-6 col-md-3" id="status-notif">
                                <h6 class="small">Notification Service</h6>
                                <span class="badge bg-secondary">Checking...</span>
                            </div>
                            <div class="col-6 col-md-3" id="status-gateway">
                                <h6 class="small">API Gateway</h6>
                                <span class="badge bg-secondary">Checking...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Login Panel -->
            <div class="col-lg-4 col-md-6 col-12 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-primary text-white">1. Autenticaci√≥n (Auth Service)</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label>Usuario</label>
                            <input type="text" id="username" class="form-control" value="admin">
                        </div>
                        <div class="mb-3">
                            <label>Contrase√±a</label>
                            <input type="password" id="password" class="form-control" value="password">
                        </div>
                        <button onclick="login()" class="btn btn-primary w-100">Iniciar Sesi√≥n</button>
                    </div>
                </div>
            </div>

            <!-- Actions Panel -->
            <div class="col-lg-4 col-md-6 col-12 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-success text-white">2. Servicios Protegidos</div>
                    <div class="card-body">
                        <p class="text-muted">Requieren Token JWT v√°lido</p>
                        <div class="d-grid gap-2">
                            <button onclick="processPayment()" class="btn btn-success" id="btn-pay" disabled>üí∞ Procesar Pago (Payment)</button>
                            <button onclick="sendNotification()" class="btn btn-info text-white" id="btn-notif" disabled>üì® Enviar Notificaci√≥n</button>
                        </div>
                        <div class="mt-3">
                            <small>Token Actual:</small>
                            <textarea id="token-display" class="form-control" rows="3" readonly style="font-size: 0.8em;"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs Panel -->
            <div class="col-lg-4 col-md-12 col-12 mb-4">
                <div class="card">
                    <div class="card-header bg-dark text-white">Logs del Sistema</div>
                    <div class="card-body p-0">
                        <div id="logs"></div>
                        <button onclick="clearLogs()" class="btn btn-sm btn-outline-secondary m-2">Limpiar Logs</button>
                    </div>
                </div>
                
                <!-- Chaos Panel -->
                <div class="card mt-3 border-danger">
                    <div class="card-header bg-danger text-white">üêµ Chaos Monkey (Simular Fallos)</div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="chaos-auth" onchange="toggleChaosAuth()">
                            <label class="form-check-label" for="chaos-auth">Auth Lento (Latencia)</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="chaos-pay" onchange="toggleChaosPay()">
                            <label class="form-check-label" for="chaos-pay">Pagos Inestables (Errores)</label>
                        </div>
                        <div class="form-check form-switch mt-2">
                            <input class="form-check-input" type="checkbox" id="chaos-crash" onchange="toggleChaosCrash()">
                            <label class="form-check-label text-danger fw-bold" for="chaos-crash">üíÄ MATAR Payment Service (Ca√≠da)</label>
                        </div>
                    </div>
                </div>

                <!-- Stress Test Panel -->
                <div class="card mt-3 border-warning">
                    <div class="card-header bg-warning text-dark">‚ö° Stress Test (Carga)</div>
                    <div class="card-body">
                        <p class="small text-muted mb-2">Env√≠a m√∫ltiples peticiones simult√°neas para probar la concurrencia.</p>
                        <button onclick="startStressTest()" class="btn btn-warning w-100 fw-bold">üöÄ Lanzar 10 Pagos (Burst)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Production: Use relative path (Nginx Proxy)
        // Development: If running without Nginx proxy, you might need 'http://localhost:8080'
        const API_URL = '/api'; 
        let currentToken = '';

        // Helper: Sleep function
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // Helper: UUID Generator
        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Helper: Fetch with Retry
        async function fetchWithRetry(url, options, retries = 3, backoff = 1000) {
            try {
                const res = await fetch(url, options);
                if (!res.ok && retries > 0) {
                    throw new Error(`Server returned ${res.status}`);
                }
                return res;
            } catch (err) {
                if (retries > 0) {
                    log(`‚ö†Ô∏è Fallo detectado (${err.message}). Reintentando en ${backoff/1000}s... (Restantes: ${retries})`, 'warning');
                    await sleep(backoff);
                    return fetchWithRetry(url, options, retries - 1, backoff * 2); // Exponential backoff
                }
                throw err;
            }
        }

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const entry = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            entry.innerHTML = `<span style="color: #888">[${time}]</span> ${message}`;
            if (type === 'error') entry.style.color = '#ff6b6b';
            if (type === 'success') entry.style.color = '#51cf66';
            if (type === 'warning') entry.style.color = '#fcc419';
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        function setLoginLoading(isLoading) {
            const btn = document.querySelector('button[onclick="login()"]');
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Autenticando...';
            } else {
                btn.disabled = false;
                btn.innerHTML = 'Iniciar Sesi√≥n';
            }
        }

        function setPaymentLoading(isLoading) {
            const btn = document.getElementById('btn-pay');
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
            } else {
                btn.disabled = false;
                btn.innerHTML = 'üí∞ Procesar Pago (Payment)';
            }
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function toggleChaosAuth() {
            const enabled = document.getElementById('chaos-auth').checked;
            log(`üêµ Chaos Auth: ${enabled ? 'Activando latencia...' : 'Desactivando...'}`, 'warning');
            try {
                await fetch(`${API_URL}/auth/chaos/latency`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
            } catch (e) { log('Error Chaos Auth', 'error'); }
        }

        async function toggleChaosPay() {
            const enabled = document.getElementById('chaos-pay').checked;
            log(`üêµ Chaos Pay: ${enabled ? 'Sembrando caos...' : 'Restaurando orden...'}`, 'warning');
            try {
                await fetch(`${API_URL}/payments/chaos/failure`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}` 
                    },
                    body: JSON.stringify({ enabled })
                });
            } catch (e) { log('Error Chaos Pay', 'error'); }
        }

        async function toggleChaosCrash() {
            const enabled = document.getElementById('chaos-crash').checked;
            log(`üíÄ Chaos Crash: ${enabled ? 'MATANDO SERVICIO DE PAGOS...' : 'REVIVIENDO SERVICIO...'}`, 'warning');
            try {
                // Notar: este endpoint NO requiere auth, para poder revivirlo f√°cilmente
                await fetch(`${API_URL}/payments/chaos/crash`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
            } catch (e) { log('Error Chaos Crash', 'error'); }
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            setLoginLoading(true);
            log(`Intentando login como <b>${username}</b>...`);

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    currentToken = data.token;
                    document.getElementById('token-display').value = currentToken;
                    document.getElementById('btn-pay').disabled = false;
                    document.getElementById('btn-notif').disabled = false;
                    log(`‚úÖ Login exitoso! Token recibido.`, 'success');
                } else {
                    log(`‚ùå Error Login: ${data.message}`, 'error');
                }
            } catch (err) {
                log(`‚ùå Error de conexi√≥n: ${err.message}`, 'error');
            } finally {
                setLoginLoading(false);
            }
        }

        async function processPayment() {
            if (!currentToken) return log('‚ö†Ô∏è No hay token. Inicia sesi√≥n primero.', 'error');
            
            setPaymentLoading(true);
            const idempotencyKey = uuidv4(); // Generate unique key
            log(`Iniciando pago de 500 EUR (Key: ${idempotencyKey.substr(0, 8)}...)...`);
            
            try {
                // Using fetchWithRetry here!
                const res = await fetchWithRetry(`${API_URL}/payments/process`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`,
                        'Idempotency-Key': idempotencyKey
                    },
                    body: JSON.stringify({ amount: 500, currency: 'EUR' })
                });
                
                const data = await res.json();
                if (res.ok) {
                    if (data.cached) {
                        log(`‚ôªÔ∏è Pago (CACHED): ${JSON.stringify(data)}`, 'success');
                    } else {
                        log(`üí∞ Pago Exitoso: ${JSON.stringify(data)}`, 'success');
                    }
                } else {
                    log(`‚ùå Error Pagos (Final): ${data.message || res.status}`, 'error');
                }
            } catch (err) {
                log(`‚ùå Error Pagos Agotado: ${err.message}`, 'error');
            } finally {
                setPaymentLoading(false);
            }
        }

        async function sendNotification() {
            if (!currentToken) return log('‚ö†Ô∏è No hay token. Inicia sesi√≥n primero.', 'error');
            
            log('Enviando notificaci√≥n de prueba...');
            try {
                const res = await fetch(`${API_URL}/notifications/send`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ to: 'usuario@demo.com', message: 'Hola desde el Frontend!' })
                });
                const data = await res.json();
                log(`üì® Respuesta Notificaciones: ${JSON.stringify(data)}`, 'success');
            } catch (err) {
                log(`‚ùå Error Notificaciones: ${err.message}`, 'error');
            }
        }

        // System Monitor
        async function checkHealth() {
            const services = [
                { id: 'status-auth', url: `${API_URL}/auth/health` },
                { id: 'status-payment', url: `${API_URL}/payments/health` },
                { id: 'status-notif', url: `${API_URL}/notifications/health` },
                { id: 'status-gateway', url: `${API_URL}/health` }
            ];

            for (const svc of services) {
                const el = document.getElementById(svc.id).querySelector('span');
                const start = performance.now();
                try {
                    // Timeout of 4s
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), 4000);
                    
                    const res = await fetch(svc.url, { signal: controller.signal });
                    clearTimeout(id);
                    const latency = Math.round(performance.now() - start);

                    if (res.ok) {
                        el.className = 'badge bg-success';
                        el.textContent = `ONLINE (${latency}ms)`;
                    } else {
                        // Check for Circuit Breaker
                        if (res.status === 503) {
                            try {
                                const data = await res.json();
                                if (data.circuitBreaker === 'OPEN') {
                                    el.className = 'badge bg-warning text-dark';
                                    el.textContent = 'CIRCUIT OPEN';
                                    continue;
                                }
                            } catch(e) {}
                        }
                        
                        el.className = 'badge bg-danger';
                        el.textContent = `ERROR ${res.status}`;
                    }
                } catch (e) {
                    el.className = 'badge bg-danger';
                    el.textContent = 'OFFLINE';
                }
            }
        }

        async function startStressTest() {
            if (!currentToken) return log('‚ö†Ô∏è No hay token. Inicia sesi√≥n primero.', 'error');
            log('üöÄ Iniciando Stress Test (10 peticiones concurrentes)...', 'warning');
            
            const promises = [];
            for (let i = 0; i < 10; i++) {
                promises.push(
                    fetch(`${API_URL}/payments/process`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${currentToken}`,
                            'Idempotency-Key': uuidv4() // Unique per request
                        },
                        body: JSON.stringify({ amount: 10 + i, currency: 'EUR' })
                    }).then(res => res.status)
                );
            }

            const results = await Promise.all(promises);
            const success = results.filter(s => s === 200).length;
            const rateLimited = results.filter(s => s === 429).length;
            const otherFails = results.filter(s => s !== 200 && s !== 429).length;
            
            log(`üèÅ Stress Test Finalizado:`, 'info');
            log(`   ‚úÖ Exitosas: ${success}`, 'success');
            if (rateLimited > 0) log(`   ‚õî Rate Limit (429): ${rateLimited}`, 'warning');
            if (otherFails > 0) log(`   ‚ùå Otros Errores: ${otherFails}`, 'error');
        }

        // Start polling
        setInterval(checkHealth, 5000);
        checkHealth(); // Initial check
    </script>
</body>
</html>